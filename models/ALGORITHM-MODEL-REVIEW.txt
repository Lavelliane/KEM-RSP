================================================================================
ALGORITHM-TO-MODEL CORRESPONDENCE REVIEW
Paper: main.tex | Models: pqc-rsp/models/*.pv
================================================================================

MODEL MAPPING (as stated in paper)
----------------------------------
- Algorithm 1 (Classical RSP)     -> original-auth.pv, original-download.pv
- Algorithm 2 (Full PQC RSP)      -> fullpqc-auth.pv, fullpqc-download.pv
- Algorithm 3 (Transport-Indep.) -> fullpqc-notls-auth.pv, fullpqc-notls-download.pv

================================================================================
MATCHES (correct correspondence)
================================================================================

1. original-auth.pv vs Algorithm 1 (Classical Phase A)
   - Signature-based: serverSigned1(tid, eChal, sChal, ID_SMDP), clientSigned1(tid, sChal)
   - Private LPA2SMDP channel (TLS)
   - Event names differ (SMDP_AUTH_BEGIN vs paper's flow) but protocol matches

2. original-download.pv vs Algorithm 1 (Classical Phase B)
   - Ephemeral DH for profile encryption, signatures for PrepareDownload, BPP, Install
   - mk_serverSigned2(tid), mk_clientSigned2(tid, pk_eu), mk_serverSigned3(tid, pk_dp)
   - Forward secrecy phase 1 leak of SK_DPauth

3. fullpqc-auth.pv vs Algorithm 2 (Full PQC Phase A)
   - Three-way KEM: ephemeral, client auth, server auth
   - Finished messages for key confirmation
   - Private LPA2SMDP, explicit LPA relay process
   - PQ-signed certs with KEM public keys

4. fullpqc-download.pv vs Algorithm 2 (Full PQC Phase B)
   - PrepareDownload: Encap(PK_EU), kdf_bind, auth_mac(tid)
   - PrepareDownloadResponse: Encap(PK_DP), auth_mac(tid || PK_prof)
   - LoadBoundProfilePackage: CT_prof (ephemeral), CT_PROFILE_AUTH (binding), profile_auth_mac
   - InstallNotification: Encap(PK_DP), kdf_bind_install(tid, iccid)

================================================================================
DISCREPANCIES (require attention)
================================================================================

A. fullpqc-auth.pv: KDF argument order
   - Paper (Alg 2, line 319): K <- KDF(SS_e || SS_c || SS_s || transcript)
     Order: ephemeral, client auth, server auth
   - Model (line 208): kemtls_kdf(SS_EPH, SS_SERVER, SS_CLIENT, ...)
     Order: ephemeral, server auth, client auth
   - Impact: Cryptographically equivalent if KDF is a random oracle over the
     concatenation; order does not affect security. But paper-model consistency
     would require aligning the order.

B. fullpqc-notls-auth.pv: CHANNEL DEADLOCK (critical)
   - eUICC sends to ES9 (line 159) but receives from LPA2EUICC (lines 162, 196)
   - SM-DP+ uses ES9 for all communication
   - There is NO LPA process in the main process
   - LPA2EUICC is private, so the attacker cannot write to it
   - Result: eUICC blocks forever on in(LPA2EUICC, ...); no process sends there
   - Fix: eUICC should receive from ES9 (and send to ES9) to model direct
     connection when LPA is subsumed by attacker. Paper states: "we do not
     model the LPA as a separate process; its function as a relay is absorbed
     into the attacker's capabilities."

C. fullpqc-notls-download.pv: CHANNEL DEADLOCK (critical)
   - Same issue: eUICC uses LPA2EUICC for in/out; SM-DP+ uses ES9
   - No LPA process to relay between them
   - Fix: eUICC should use ES9 for all network communication

D. fullpqc-notls-download.pv: MISSING PROFILE BINDING AUTHENTICATION
   - Paper (Alg 2 detailed, lines 818-819): BoundProfilePackage includes
     CT_auth <- Encap(PK_EU^KEM), mac_auth <- MAC(KDF_bind(SS_auth, tid), BPP)
   - fullpqc-download.pv has: CT_PROFILE_AUTH, profile_auth_mac (correct)
   - fullpqc-notls-download.pv has: only CT_PROFILE, encrypted_prof, profile_mac
   - The extra KEM layer (CT_auth) that authenticates the BPP to the eUICC
     is missing in fullpqc-notls-download.pv
   - Impact: fullpqc-notls-download models a simplified Phase B that does not
     match the paper's Algorithm 2/3 specification

E. fullpqc-notls-download.pv: Different message structure for BPP
   - Paper: bpp_body = (tid, PK_prof, CT_prof, encrypted_profile), plus
     separate bpp_mac, CT_auth, mac_auth
   - fullpqc-notls: msg_profile(tid, CT_PROFILE, encrypted_prof) for MAC,
     single k_profile from SS_PROFILE (no separate enc/mac keys)
   - fullpqc-download: kdf_enc, kdf_mac from SS_PROFILE; profile_mac(bpp_body, k_mac)
   - fullpqc-notls uses kdf_profile(SS_PROFILE) -> single SymKey_t, then
     mac(k_profile, msg_profile(...)). So one key for both enc and MAC?
   - fullpqc-download uses kdf_enc and kdf_mac separately. Different structure.

F. Install confirmation KDF
   - Paper: mac_inst <- MAC(KDF_bind(SS_inst, tid), ICCID)
   - fullpqc-download: kdf_bind_install(SS_INSTALL, tid, iccid), MAC over
     mk_install_result(tid, iccid)
   - fullpqc-notls: kdf_bind(SS_INSTALL, tid), MAC over msg_install(tid, iccid)
   - fullpqc-notls uses kdf_bind (no iccid in KDF), fullpqc-download uses
     kdf_bind_install with iccid. Minor difference.

================================================================================
SUMMARY OF REQUIRED FIXES
================================================================================

1. fullpqc-notls-auth.pv: Change eUICC to use ES9 for all network I/O
   (in/out) instead of LPA2EUICC. Remove or repurpose LPA2EUICC.

2. fullpqc-notls-download.pv: Change eUICC to use ES9 for all network I/O.

3. fullpqc-notls-download.pv: Add CT_PROFILE_AUTH and profile_auth_mac to
   match the paper's profile binding authentication. Align BPP structure
   with fullpqc-download.pv (bpp_body, bpp_mac, CT_PROFILE, CT_PROFILE_AUTH,
   profile_auth_mac) and use kdf_enc/kdf_mac for profile encryption.

4. (Optional) fullpqc-auth.pv: Align KDF argument order with paper
   (SS_e, SS_c, SS_s) for documentation consistency.

================================================================================
